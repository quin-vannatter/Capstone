function initSocket(e){var t=e?"spectate=true":"spectate=false&playerName="+playerName;socket=io(serverIP,{query:t}),socket.on("connect",function(e){}),socket.on("initialize game",function(e){initGame(e)}),socket.on("spawn player",function(e){player=new Player(e.loc,"img/player.png",e.playerId,playerName),camera=new Camera(player,canvas),input=new Input(canvas,camera),game.addObject(player)}),socket.on("player joined",function(e){game.addObject(createObjectFromTransit(e))}),socket.on("player quit",function(e){game.removePlayer(e)}),socket.on("player shot",function(e){game.addObject(createObjectFromTransit(e))}),socket.on("player moved",function(e){game.updatePlayerLocAndVel(e.playerId,e.loc,e.vel)}),socket.on("player teleported",function(e){var t=game.getPlayerById(e.playerId);t.teleport(e.loc)}),socket.on("update own position",function(e){player.setLoc(e)}),socket.on("respawn player",function(e){var t=game.getPlayerById(e.playerId);t.respawnPlayer(e.loc)}),socket.on("player died",function(e){var t=game.getPlayerById(e);t.killPlayer()}),socket.on("update all players",function(e){for(var t=0;t<e.length;t++){var a=game.getPlayerById(e[t].playerId);("undefined"==typeof player||a.getId()!==player.getId())&&(a.setUpdateLoc(e[t].loc),a.setVel(e[t].velocity)),Math.abs(a.getHealth()-e[t].health)>29&&a.setHealth(e[t].health),a.setNumKills(e[t].numKills),a.setNumDeaths(e[t].numDeaths)}})}function startGame(e){e.keyIdentifier!==KEY_ENTER&&"click"!=e.type||startedGame||(playerName=document.getElementById("playerName").value.trim(),playerName.length<1&&(playerName=NAME_DEFAULT),playerName=playerName.substr(0,NAME_MAX_LENGTH),document.getElementById("input").style.display="none",socket.emit("join game",playerName),startedGame=!0)}function findFocus(){spectateIndex=-1;var e=game.getAllPlayers();e.length>0&&(spectateIndex=Math.floor(Math.random()*e.length));var t;if(-1!=spectateIndex)t=e[spectateIndex];else{var a=game.getGameObjects(),n=Math.floor(Math.random()*a.length);t=a[n]}"undefined"==typeof camera?camera=new Camera(t,canvas):camera.setFocus(t)}function drawGame(){context.clearRect(0,0,canvas.width,canvas.height),backgroundPattern=context.createPattern(backgroundImg,"repeat"),context.fillStyle=backgroundPattern,context.fillRect(0,0,canvas.width,canvas.height),game.getGameObjects().forEach(function(e){if(null!=e.getTex()){var t=e.getAlpha(),a=camera.calculateOffset(e),n=e.getSize(),r=(n.width*(2-t)-n.width)/2,o=(n.height*(2-t)-n.height)/2;if(1!=t&&(context.globalAlpha=t),e.isPattern()){context.translate(a.x-r,a.y-o);var l=context.createPattern(e.getTex(),"repeat");context.fillStyle=l,context.fillRect(0,0,n.width*(2-t),n.height*(2-t)),context.translate(-(a.x-r),-(a.y-o))}else{var c={width:n.width*(2-t),height:n.height*(2-t)};context.drawImage(e.getTex(),a.x-r,a.y-o,c.width,c.height),"Player"!==e.constructor.name||e.getTeleporting()||(1!==e.getHealthPercent()&&drawHealth(a,r,o,e,c),drawKD(a,r,o,e,c),drawName(a,r,o,e,c))}1!==t&&(context.globalAlpha=1)}});context.globalAlpha;"undefined"!=typeof player&&(drawLeaderBoard(),drawMap())}function drawMap(){var e=context.globalAlpha,t=(game.mapBounds.max.x-game.mapBounds.min.x)/(game.mapBounds.max.y-game.mapBounds.min.y)*200,a={x:canvas.width-t-4,y:canvas.height-204,width:t,height:200,pieceSize:{x:8,y:8}},n=new Image,r=game.getAllPlayers();context.globalAlpha=LEADERBOARD_ALPHA,context.fillStyle="#000000",context.fillRect(a.x,a.y,a.width,a.height);for(var o=0;o<r.length;o++)if(!r[o].isDead()){var l=r[o].getLoc(),c={x:(l.x-game.mapBounds.min.x)/(game.mapBounds.max.x-game.mapBounds.min.x)*a.width+a.x,y:(l.y-game.mapBounds.min.y)/(game.mapBounds.max.y-game.mapBounds.min.y)*a.height+a.y};"undefined"==typeof player||player.getId()!==r[o].getId()?n.src="img/player2.png":n.src="img/player.png",context.drawImage(n,c.x,c.y,a.pieceSize.x,a.pieceSize.y)}context.globalAlpha=e}function drawHealth(e,t,a,n,r){var o=n.getHealthBarOffset(r.height),l=n.getHealthBarSize(),c={x:e.x-t+o.x,y:e.y-a+o.y},i=n.getHealthOffsetInBar(),p={x:c.x+i.x,y:c.y+i.y,width:n.getHealthPercent()*i.width,height:i.height};context.fillStyle=COLOUR_HEALTH_BACKGROUND,context.fillRect(c.x,c.y,l.width,l.height),context.fillStyle=COLOUR_HEALTH,context.fillRect(p.x,p.y,p.width,p.height)}function drawName(e,t,a,n,r){var o=n.getNameOffset(r.height),l={x:e.x-t+o.x,y:e.y-a+o.y};context.font=TEXT_NAME,context.fillStyle=COLOUR_NAME;var c=n.getName(),i=context.measureText(c).width;context.fillText(c,l.x-i/2,l.y)}function drawKD(e,t,a,n,r){var o=n.getKDOffset(r.height),l={x:e.x-t+o.x,y:e.y-a+o.y};context.font=TEXT_KD,context.fillStyle=COLOUR_KD;var c=n.getKDString(),i=context.measureText(c).width;context.fillText(c,l.x-i/2,l.y)}function drawLeaderBoard(){var e=context.globalAlpha,t=game.getLeaders(),a={x:14,y:64,height:20,headY:29,baseWidth:200,baseHeight:47,heightPerPlayer:20,kdLoc:{x:16,y:47}},n=0;context.font=TEXT_LEADER;for(var r=0;r<t.length;r++){var o=t[r].getLeaderString(),l=context.measureText(o).width;l>n&&(n=l)}n+=20,context.globalAlpha=LEADERBOARD_ALPHA,context.fillStyle="#000000",context.fillRect(4,4,Math.max(a.baseWidth,n),a.baseHeight+t.length*a.heightPerPlayer),context.globalAlpha=1,context.font=TEXT_LEADER_HEADING,context.fillStyle=COLOUR_LEADERBOARD,context.fillText("SCOREBOARD",a.x,a.headY),context.font=TEXT_KD_HEADER,context.fillText("K/D",a.kdLoc.x,a.kdLoc.y),context.font=TEXT_LEADER;for(var r=0;r<t.length;r++)context.fillText(t[r].getLeaderString(),a.x,a.y+r*a.height);context.globalAlpha=e}function processMovement(e){var t={x:0,y:0};e.up?t.y=-1:e.down&&(t.y=1),e.left?t.x=-1:e.right&&(t.x=1),t=Vector.multiply(Vector.normalize(t),player.speed);var a={loc:player.getLoc(),vel:t};socket.emit("update movement",a),player.setVel(t)}function processMouse(e,t){if(e.teleport&&!t.teleport&&player.canTeleport()){var a=input.getCursor(),n=player.getSize(),r={x:a.x-n.width/2,y:a.y-n.height/2},o=game.mapBounds;if(game.getDistance(r,player.getLoc())>player.getMaxTeleport()){var l=Vector.multiply(Vector.normalize(Vector.delta(r,player.getLoc())),player.getMaxTeleport());r={x:player.getLoc().x+l.x,y:player.getLoc().y+l.y}}r.x=Math.max(Math.min(o.max.x-n.width,r.x),o.min.x),r.y=Math.max(Math.min(o.max.y-n.height,r.y),o.min.y),player.teleport(r),socket.emit("teleport attempt",r)}if(e.shoot&&!t.shoot){var r={x:input.getCursor().x,y:input.getCursor().y};null!==game.attemptShot(player.getId(),r)&&socket.emit("shot attempt",r)}}function updateInput(){var e=input.getChanges(),t=input.getInput(),a=input.getOldInput();e.changed&&(processMovement(t),processMouse(t,a)),input.updateOld()}function initGame(e){game=new Game,e.gameObjects.forEach(function(e){game.addObject(createObjectFromTransit(e))},this),game.setSpawnLocations(e.spawns),playGame=!0,game.calculateMapBounds()}function createObjectFromTransit(e){switch(e.type){case"Block":return new Block(e.loc,e.size);case"Player":var t=new Player(e.loc,"img/player2.png",e.playerId,e.playerName);return t.setVel(e.velocity),t;case"Shot":return new Shot(e.ownerId,e.loc,e.vel)}}function resizeCanvas(){canvas.width=window.innerWidth,canvas.height=window.innerHeight,"undefined"!=typeof camera&&camera.reCenter()}var canvas,context,game,player,input,camera,backgroundImg,backgroundPattern,socket,playGame=!1,startedGame=!1,spectateIndex=-1,spectateWait=SPECTATE_COUNT,SPECTATE_COUNT=600,COLOUR_HEALTH="#C90808",COLOUR_HEALTH_BACKGROUND="#473E2F",COLOUR_KD="#18556B",COLOUR_NAME="#124557",COLOUR_LEADERBOARD="#8ED479",LEADERBOARD_ALPHA=.5,TEXT_NAME="15px Verdana",TEXT_KD="15px Verdana",TEXT_LEADER_HEADING="25px Verdana",TEXT_LEADER="16px Verdana",TEXT_KD_HEADER="13px Verdana",KEY_ENTER="Enter",NAME_DEFAULT="anonymous",NAME_MAX_LENGTH=15,playerName="",serverIP;document.addEventListener("DOMContentLoaded",function(){serverIP=location.href,canvas=document.getElementById("canvas"),document.addEventListener("keyup",startGame),document.getElementById("play").addEventListener("click",startGame),initSocket(),canvas.oncontextmenu=function(e){e.preventDefault()},context=canvas.getContext("2d"),resizeCanvas(),backgroundImg=new Image,backgroundImg.src="img/bg.png",window.addEventListener("resize",resizeCanvas),setInterval(function(){playGame&&("undefined"!=typeof player?player.getKill()||updateInput():spectateWait>0?spectateWait--:(findFocus(),spectateWait=SPECTATE_COUNT),game.update(),camera.update(),drawGame())},Game.UPDATE_INTERVAL),document.getElementById("playerName").focus()});